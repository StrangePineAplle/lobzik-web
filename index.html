<body>
    <div class="Main">
        <h1>Выберите мероприятие</h1>
        <select class="event-select"></select>
        <button class="btn select-event-btn">Выбрать</button>
    </div>

    <form class="test-form" style="display:none;">
        <input type="text" placeholder="Введите ФИО" class="full-name-inp">
        <input type="text" placeholder="Введите телефон" class="phone-inp">
        <input type="email" placeholder="Введите email" class="email-inp">
        <button type="button" class="btn s-btn">Отправить</button>
    </form>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;

        const type = new URLSearchParams(window.location.search).get("type"); // event, intense и т.д.
        const eventSelect = document.querySelector(".event-select");
        const selectBtn = document.querySelector(".select-event-btn");
        const form = document.querySelector(".test-form");

        let selectedEventId = null;

        fetch(`http://localhost:5000/api/${type}`)
            .then(res => res.json())
            .then(events => {
                for (let event of events) {
                    const option = document.createElement("option");
                    option.value = event.id;
                    option.textContent = `${event.date} ${event.time} — ${event.name} (${event.remaining_seats} мест)`;
                    eventSelect.appendChild(option);
                }
            });

        selectBtn.addEventListener("click", () => {
            selectedEventId = eventSelect.value;
            document.querySelector(".Main").style.display = "none";
            form.style.display = "block";
        });

        document.querySelector(".s-btn").addEventListener("click", () => {
            const fullName = document.querySelector(".full-name-inp").value;
            const phone = document.querySelector(".phone-inp").value;
            const email = document.querySelector(".email-inp").value;

            const userData = {
                tg_id: tg.initDataUnsafe.user.id,
                tg_username: tg.initDataUnsafe.user.username,
                full_name: fullName,
                phone: phone,
                email: email,
                event_id: selectedEventId
            };

            fetch(`http://localhost:5000/api/register/${type}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(userData)
            }).then(res => res.json())
              .then(response => {
                if (response.success) {
                    tg.close();
                } else {
                    alert("Ошибка при регистрации");
                }
            });
        });
    </script>
</body>
